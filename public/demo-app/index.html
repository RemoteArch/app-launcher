<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test AppPlugin</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f7;
      color: #333;
    }
    h1 {
      color: #007aff;
      margin-bottom: 20px;
    }
    .section {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    button {
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #0056b3;
    }
    input[type="text"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 5px;
      width: 300px;
      max-width: 100%;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background-color: #f0f0f0;
      border-radius: 5px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    .success {
      color: #388e3c;
    }
    .error {
      color: #d32f2f;
    }
    .status {
      margin-top: 10px;
      font-style: italic;
    }
  </style>
  <script src="../app-launcher.iife.js"></script>
</head>
<body>
  <h1>Test AppPlugin</h1>
  
  <div class="status" id="bridgeStatus">Vérification de la disponibilité du bridge...</div>
  
  <div class="section">
    <h2>Fichiers</h2>
    <div>
      <input type="text" id="filePath" placeholder="Chemin du fichier (ex: docs/test.txt)" value="docs/test.txt">
      <input type="text" id="fileContent" placeholder="Contenu du fichier" value="Ceci est un test créé le: ">
    </div>
    <div>
      <button id="createFileBtn">Créer Fichier</button>
      <button id="readFileBtn">Lire Fichier</button>
      <button id="deleteFileBtn">Supprimer Fichier</button>
    </div>
    <div class="result" id="fileResult">Les résultats apparaîtront ici</div>
  </div>
  
  <div class="section">
    <h2>Raccourcis</h2>
    <button id="createShortcutBtn">Créer Raccourci / Installer PWA</button>
    <div class="result" id="shortcutResult">Les résultats apparaîtront ici</div>
  </div>
  
  <div class="section">
    <h2>Exécution de Commandes (Natif Uniquement)</h2>
    <input type="text" id="commandInput" placeholder="Entrez une commande" value="ls -la">
    <button id="execCommandBtn">Exécuter</button>
    <div class="result" id="commandResult">Les résultats apparaîtront ici</div>
  </div>

  <script>
    // Vérifier si le bridge est disponible
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const statusElement = document.getElementById('bridgeStatus');
        
        // Vérifier si appPlugin est disponible
        if (window.appPlugin) {
          statusElement.textContent = "✅ AppPlugin est disponible - Utilisation de l'API Promise";
          statusElement.className = "status success";
          initializeAppBridgeCallback(); // On utilise la même fonction mais avec l'API Promise
        }
        // Sinon vérifier si le bridge classique est disponible
        else if (window.AppBridge) {
          statusElement.textContent = "✅ AppBridge est disponible - Utilisation de l'API Callback (obsolète)";
          statusElement.className = "status success";
          initializeAppBridgeCallback();
        } 
        // Aucun bridge disponible
        else {
          statusElement.textContent = "❌ Aucun bridge n'est disponible. Cette page doit être exécutée dans l'App Launcher.";
          statusElement.className = "status error";
        }
      }, 1000);
    });

    // Initialiser avec l'API Promise (window.appPlugin)
    function initializeAppBridgeCallback() {
      // Gestion des fichiers
      document.getElementById('createFileBtn').addEventListener('click', async () => {
        const resultElement = document.getElementById('fileResult');
        const path = document.getElementById('filePath').value;
        let content = document.getElementById('fileContent').value;
        
        if (!path) {
          resultElement.textContent = "Veuillez spécifier un chemin de fichier";
          resultElement.className = "result error";
          return;
        }
        
        content += new Date().toISOString();
        
        resultElement.textContent = "Création du fichier...";
        resultElement.className = "result";
        
        try {
          const result = await window.appPlugin.createFile({ path, data: content });
          resultElement.textContent = `Fichier créé avec succès: ${path}`;
          resultElement.className = "result success";
        } catch (error) {
          resultElement.textContent = `Erreur: ${error.message}`;
          resultElement.className = "result error";
        }
      });
      
      document.getElementById('readFileBtn').addEventListener('click', async () => {
        const resultElement = document.getElementById('fileResult');
        const path = document.getElementById('filePath').value;
        
        if (!path) {
          resultElement.textContent = "Veuillez spécifier un chemin de fichier";
          resultElement.className = "result error";
          return;
        }
        
        resultElement.textContent = "Lecture du fichier...";
        resultElement.className = "result";
        
        try {
          const result = await window.appPlugin.readFile({ path });
          resultElement.textContent = `Contenu: ${result.data}`;
          resultElement.className = "result success";
        } catch (error) {
          resultElement.textContent = `Erreur: ${error.message}`;
          resultElement.className = "result error";
        }
      });
      
      document.getElementById('deleteFileBtn').addEventListener('click', async () => {
        const resultElement = document.getElementById('fileResult');
        const path = document.getElementById('filePath').value;
        
        if (!path) {
          resultElement.textContent = "Veuillez spécifier un chemin de fichier";
          resultElement.className = "result error";
          return;
        }
        
        resultElement.textContent = "Suppression du fichier...";
        resultElement.className = "result";
        
        try {
          const result = await window.appPlugin.deleteFile({ path });
          resultElement.textContent = `Fichier supprimé avec succès: ${path}`;
          resultElement.className = "result success";
        } catch (error) {
          resultElement.textContent = `Erreur: ${error.message}`;
          resultElement.className = "result error";
        }
      });
      
      // Raccourcis
      document.getElementById('createShortcutBtn').addEventListener('click', async () => {
        const resultElement = document.getElementById('shortcutResult');
        
        resultElement.textContent = "Création du raccourci...";
        resultElement.className = "result";
        
        try {
          const result = await window.appPlugin.createShortcut({
            title: 'App Launcher Demo',
            url: "applauncher://url?u=" + encodeURIComponent(window.location.href)
          });
          resultElement.textContent = `Résultat: ${result.message || 'Succès'}`;
          resultElement.className = "result success";
        } catch (error) {
          resultElement.textContent = `Erreur: ${error.message}`;
          resultElement.className = "result error";
        }
      });
      
      // Exécution de commandes
      document.getElementById('execCommandBtn').addEventListener('click', async () => {
        const resultElement = document.getElementById('commandResult');
        const command = document.getElementById('commandInput').value;
        
        if (!command) {
          resultElement.textContent = "Veuillez entrer une commande";
          resultElement.className = "result error";
          return;
        }
        
        resultElement.textContent = `Exécution: ${command}`;
        resultElement.className = "result";
        
        try {
          const result = await window.appPlugin.execCommand({ command });
          resultElement.textContent = `Sortie:\n${result.output}`;
          resultElement.className = "result success";
        } catch (error) {
          resultElement.textContent = `Erreur: ${error.message}`;
          resultElement.className = "result error";
        }
      });
    }
  </script>
</body>
</html>